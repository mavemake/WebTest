{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <div class="me-3">
                    {% if post.author.profile_image and post.author.profile_image != 'default_profile.jpg' %}
                        <img src="{{ url_for('static', filename=post.author.profile_image) }}" alt="Profile Picture" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                    {% else %}
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white" style="width: 50px; height: 50px;">
                            <i class="bi bi-person"></i>
                        </div>
                    {% endif %}
                </div>
                <div>
                    <h5 class="mb-0">{{ post.author.first_name }} {{ post.author.last_name }}</h5>
                    <small class="text-muted">{{ post.author.location }} Â· {{ post.date_posted.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
                {% if current_user == post.author %}
                    <div class="ms-auto">
                        <div class="dropdown">
                            <button class="btn btn-link" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Edit</a></li>
                                <li><a class="dropdown-item" href="#">Delete</a></li>
                            </ul>
                        </div>
                    </div>
                {% endif %}
            </div>
            {% if post.title %}
                <h4>{{ post.title }}</h4>
            {% endif %}
            <p>{{ post.content }}</p>
            {% if post.media_files %}
                {% for media in post.media_files %}
                    {% if media.media_type == 'image' %}
                        <img src="{{ media.filename }}" class="img-fluid rounded mb-3" alt="Post image" style="cursor: pointer; max-width: 100%; height: auto;">
                    {% elif media.media_type == 'video' %}
                        <video controls class="img-fluid rounded mb-3" style="max-width: 100%; height: auto;">
                            <source src="{{ media.filename }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    {% endif %}
                {% endfor %}
            {% elif post.media_url %}
                <!-- Fallback for old posts with single media -->
                {% if post.media_type == 'image' %}
                    <img src="{{ post.media_url }}" class="img-fluid rounded mb-3" alt="Post image" style="cursor: pointer; max-width: 100%; height: auto;">
                {% elif post.media_type == 'video' %}
                    <video controls class="img-fluid rounded mb-3" style="max-width: 100%; height: auto;">
                        <source src="{{ post.media_url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                {% endif %}
            {% endif %}
            <div class="d-flex border-top border-bottom py-2">
                {% set user_liked = post.likes | selectattr('user_id', 'equalto', current_user.id) | list if current_user.is_authenticated else [] %}
                <button class="btn btn-sm like-button {{ 'liked' if user_liked else '' }}" 
                        data-post-id="{{ post.id }}">
                    <i class="bi bi-heart"></i> <span class="like-count">{{ post.like_count() }}</span>
                </button>
                <button class="btn btn-sm">
                    <i class="bi bi-chat"></i> {{ post.comments|length }}
                </button>
                <button class="btn btn-sm share-button" data-post-id="{{ post.id }}">
                    <i class="bi bi-share"></i> <span class="share-count">{{ post.share_count() }}</span>
                </button>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h5>{{ comments|length }} Comments</h5>
            </div>
            <div class="card-body">
                {% if current_user.is_authenticated %}
                    <form method="POST" action="{{ url_for('main.comment_post', post_id=post.id) }}" class="mb-4" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            {{ form.content(class="form-control", placeholder="Write a comment...", rows="3") }}
                        </div>
                        <div class="mb-3">
                            {{ form.media.label(class="form-label") }}
                            <div class="custom-file-upload">
                                <label for="{{ form.media.id }}" class="btn btn-outline-primary rounded-circle" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-plus-lg"></i>
                                </label>
                                {{ form.media(class="form-control d-none", multiple=True) }}
                            </div>
                            <div id="comment-media-preview" class="mt-2"></div>
                        </div>
                        <div class="d-flex justify-content-end">
                            {{ form.submit(class="btn btn-primary btn-sm") }}
                        </div>
                    </form>
                {% endif %}

                {% for comment in comments %}
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="me-2">
                                {% if comment.author.profile_image and comment.author.profile_image != 'default_profile.jpg' %}
                                    <img src="{{ url_for('static', filename=comment.author.profile_image) }}" alt="Profile Picture" class="rounded-circle" style="width: 30px; height: 30px; object-fit: cover;">
                                {% else %}
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white" style="width: 30px; height: 30px;">
                                        <i class="bi bi-person" style="font-size: 0.7rem;"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <h6 class="mb-0" style="font-size: 0.9rem;">{{ comment.author.first_name }} {{ comment.author.last_name }}</h6>
                                <small class="text-muted">{{ comment.date_posted.strftime('%Y-%m-%d %H:%M') }}</small>
                            </div>
                        </div>
                        <p class="mb-1">{{ comment.content }}</p>
                        {% if comment.media_files %}
                            {% for media in comment.media_files %}
                                {% if media.media_type == 'image' %}
                                    <img src="{{ media.filename }}" class="img-fluid rounded mb-2" alt="Comment image" style="max-width: 200px; cursor: pointer;">
                                {% elif media.media_type == 'video' %}
                                    <video controls class="img-fluid rounded mb-2" style="max-width: 200px;">
                                        <source src="{{ media.filename }}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                {% endif %}
                            {% endfor %}
                        {% elif comment.media_url %}
                            <!-- Fallback for old comments with single media -->
                            {% if comment.media_type == 'image' %}
                                <img src="{{ comment.media_url }}" class="img-fluid rounded mb-2" alt="Comment image" style="max-width: 200px; cursor: pointer;">
                            {% elif comment.media_type == 'video' %}
                                <video controls class="img-fluid rounded mb-2" style="max-width: 200px;">
                                    <source src="{{ comment.media_url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            {% endif %}
                        {% endif %}
                        <!-- Reaction buttons -->
                        <div class="reaction-buttons mt-2">
                            <button class="btn btn-sm btn-outline-danger react-button" data-comment-id="{{ comment.id }}" data-reaction="heart">
                                <i class="bi bi-heart"></i> <span class="reaction-count-heart" data-comment-id="{{ comment.id }}">{{ comment.reactions | selectattr('reaction_type', 'equalto', 'heart') | list | length }}</span>
                            </button>
                            <button class="btn btn-sm btn-outline-warning react-button" data-comment-id="{{ comment.id }}" data-reaction="wow">
                                <i class="bi bi-emoji-surprise"></i> <span class="reaction-count-wow" data-comment-id="{{ comment.id }}">{{ comment.reactions | selectattr('reaction_type', 'equalto', 'wow') | list | length }}</span>
                            </button>
                            <button class="btn btn-sm btn-outline-primary react-button" data-comment-id="{{ comment.id }}" data-reaction="angry">
                                <i class="bi bi-emoji-angry"></i> <span class="reaction-count-angry" data-comment-id="{{ comment.id }}">{{ comment.reactions | selectattr('reaction_type', 'equalto', 'angry') | list | length }}</span>
                            </button>
                            <button class="btn btn-sm btn-outline-success react-button" data-comment-id="{{ comment.id }}" data-reaction="hahaha">
                                <i class="bi bi-emoji-laughing"></i> <span class="reaction-count-hahaha" data-comment-id="{{ comment.id }}">{{ comment.reactions | selectattr('reaction_type', 'equalto', 'hahaha') | list | length }}</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary react-button" data-comment-id="{{ comment.id }}" data-reaction="sad">
                                <i class="bi bi-emoji-frown"></i> <span class="reaction-count-sad" data-comment-id="{{ comment.id }}">{{ comment.reactions | selectattr('reaction_type', 'equalto', 'sad') | list | length }}</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary reply-button" data-comment-id="{{ comment.id }}">
                                <i class="bi bi-reply"></i> Reply
                            </button>
                        </div>
                        
                        <!-- Reply form (hidden by default) -->
                        <div class="reply-form mt-2" id="reply-form-{{ comment.id }}" style="display: none;">
                            <form method="POST" action="{{ url_for('main.reply_to_comment', comment_id=comment.id) }}" enctype="multipart/form-data">
                                <div class="mb-2">
                                    <textarea name="content" class="form-control" rows="2" placeholder="Write a reply..."></textarea>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button type="submit" class="btn btn-primary btn-sm">Reply</button>
                                    <button type="button" class="btn btn-secondary btn-sm cancel-reply">Cancel</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Display replies -->
                        {% if comment.replies %}
                            <div class="replies ms-4 mt-3">
                                {% for reply in comment.replies %}
                                    <div class="border-bottom pb-2 mb-2">
                                        <div class="d-flex align-items-center mb-1">
                                            <div class="me-2">
                                                {% if reply.author.profile_image and reply.author.profile_image != 'default_profile.jpg' %}
                                                    <img src="{{ url_for('static', filename=reply.author.profile_image) }}" alt="Profile Picture" class="rounded-circle" style="width: 25px; height: 25px; object-fit: cover;">
                                                {% else %}
                                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white" style="width: 25px; height: 25px;">
                                                        <i class="bi bi-person" style="font-size: 0.6rem;"></i>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <h6 class="mb-0" style="font-size: 0.8rem;">{{ reply.author.first_name }} {{ reply.author.last_name }}</h6>
                                                <small class="text-muted">{{ reply.date_posted.strftime('%Y-%m-%d %H:%M') }}</small>
                                            </div>
                                        </div>
                                        <p class="mb-1" style="font-size: 0.9rem;">{{ reply.content }}</p>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById("{{ form.media.id }}").addEventListener('change', function(event) {
        const files = event.target.files;
        const preview = document.getElementById('comment-media-preview');
        
        // Clear previous preview
        preview.innerHTML = '';
        
        // Handle multiple files
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    if (file.type.startsWith('image/')) {
                        // Create image preview
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'img-fluid rounded';
                        img.style.maxHeight = '200px';
                        img.style.marginRight = '10px';
                        img.style.marginBottom = '10px';
                        preview.appendChild(img);
                    } else if (file.type.startsWith('video/')) {
                        // Create video preview
                        const video = document.createElement('video');
                        video.src = e.target.result;
                        video.className = 'img-fluid rounded';
                        video.style.maxHeight = '200px';
                        video.style.marginRight = '10px';
                        video.style.marginBottom = '10px';
                        video.controls = true;
                        preview.appendChild(video);
                    }
                };
                
                reader.readAsDataURL(file);
            }
        }
    });
    
    // Handle reply buttons
    document.querySelectorAll('.reply-button').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            const replyForm = document.getElementById('reply-form-' + commentId);
            replyForm.style.display = 'block';
        });
    });
    
    // Handle cancel reply buttons
    document.querySelectorAll('.cancel-reply').forEach(button => {
        button.addEventListener('click', function() {
            const replyForm = this.closest('.reply-form');
            replyForm.style.display = 'none';
            // Clear the textarea
            replyForm.querySelector('textarea').value = '';
        });
    });
    
    // Handle reaction buttons
    document.querySelectorAll('.react-button').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            const reactionType = this.getAttribute('data-reaction');
            
            // Send AJAX request to react to comment
            fetch(`/comment/${commentId}/react`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `reaction_type=${reactionType}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    // Update all reaction counts
                    document.querySelector(`.reaction-count-heart[data-comment-id="${commentId}"]`).textContent = 
                        data.reaction_counts.heart;
                    document.querySelector(`.reaction-count-wow[data-comment-id="${commentId}"]`).textContent = 
                        data.reaction_counts.wow;
                    document.querySelector(`.reaction-count-angry[data-comment-id="${commentId}"]`).textContent = 
                        data.reaction_counts.angry;
                    document.querySelector(`.reaction-count-hahaha[data-comment-id="${commentId}"]`).textContent = 
                        data.reaction_counts.hahaha;
                    document.querySelector(`.reaction-count-sad[data-comment-id="${commentId}"]`).textContent = 
                        data.reaction_counts.sad;
                    
                    // Remove active class from all reaction buttons for this comment
                    document.querySelectorAll(`.react-button[data-comment-id="${commentId}"]`).forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to the clicked button if reaction was added
                    if (data.action === 'added') {
                        this.classList.add('active');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while reacting to the comment.');
            });
        });
    });
</script>
{% endblock %}